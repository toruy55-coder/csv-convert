<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSVçµåˆãƒ»å¤‰æ›ãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            transition: all 0.3s;
        }
        .tab:hover {
            background: #e9ecef;
        }
        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        .tab-content {
            display: none;
            padding: 30px;
        }
        .tab-content.active {
            display: block;
        }
        .section {
            margin-bottom: 30px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #212529;
            display: flex;
            align-items: center;
        }
        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #667eea;
            margin-right: 10px;
            border-radius: 2px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: block;
            width: 100%;
        }
        .file-drop-zone {
            border: 2px dashed #ced4da;
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s;
            cursor: pointer;
        }
        .file-drop-zone:hover {
            border-color: #667eea;
            background: #e9ecef;
        }
        .file-drop-zone.drag-over {
            border-color: #667eea;
            background: #e7e9ff;
            border-style: solid;
        }
        .file-input-button {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
            margin-bottom: 10px;
        }
        .file-input-button:hover {
            background: #5568d3;
        }
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        .file-name {
            display: block;
            color: #6c757d;
            font-size: 14px;
            margin-top: 5px;
        }
        .file-drop-hint {
            font-size: 13px;
            color: #6c757d;
            margin-top: 5px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5568d3;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #218838;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-top: 10px;
            overflow: auto;
        }
        .preview-table th,
        .preview-table td {
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            text-align: left;
        }
        .preview-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        .preview-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .column-list {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
        }
        .column-item {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            cursor: move;
            transition: background 0.2s;
        }
        .column-item:last-child {
            border-bottom: none;
        }
        .column-item:hover {
            background: #f8f9fa;
        }
        .column-item.dragging {
            opacity: 0.5;
            background: #e9ecef;
        }
        .column-item.drag-over {
            border-top: 3px solid #667eea;
        }
        .column-checkbox {
            margin-right: 12px;
            cursor: pointer;
        }
        .column-source {
            background: #e9ecef;
            color: #495057;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            margin-right: 10px;
            font-weight: 600;
        }
        .column-name {
            flex: 1;
            font-size: 14px;
            color: #212529;
        }
        .column-rename {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 13px;
        }
        .drag-handle {
            margin-right: 10px;
            color: #adb5bd;
            cursor: move;
        }
        .rule-list {
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .rule-item {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .rule-item:last-child {
            border-bottom: none;
        }
        .rule-item input,
        .rule-item select {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 13px;
        }
        .validation-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
        }
        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
        }
        .checkbox-group label {
            font-size: 14px;
            color: #495057;
            cursor: pointer;
        }
        .settings-list {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        .settings-item {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .settings-item:last-child {
            border-bottom: none;
        }
        .settings-name {
            flex: 1;
            font-size: 14px;
            color: #212529;
            cursor: pointer;
        }
        .settings-name:hover {
            color: #667eea;
        }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .alert {
            padding: 15px 20px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
        }
        .alert-success {
            background: #d4edda;
            border: 1px solid #28a745;
            color: #155724;
        }
        .alert-danger {
            background: #f8d7da;
            border: 1px solid #dc3545;
            color: #721c24;
        }
        .alert-info {
            background: #d1ecf1;
            border: 1px solid #17a2b8;
            color: #0c5460;
        }
        .result-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .result-summary-item {
            margin-bottom: 8px;
            font-size: 14px;
        }
        .result-summary-item strong {
            color: #495057;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #212529;
        }
        .modal-body {
            margin-bottom: 20px;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
        .log-item {
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .log-title {
            font-weight: 600;
            font-size: 14px;
            color: #212529;
        }
        .log-date {
            font-size: 12px;
            color: #6c757d;
        }
        .log-details {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
            font-size: 13px;
        }
        .log-details.show {
            display: block;
        }
        .log-detail-item {
            margin-bottom: 5px;
        }
        .warning-badge {
            background: #ffc107;
            color: #856404;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }
        .summary-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        .summary-item {
            margin-bottom: 5px;
            font-size: 14px;
        }
        .mismatch-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin-top: 5px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š CSVçµåˆãƒ»å¤‰æ›ãƒ„ãƒ¼ãƒ«</h1>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="define">å®šç¾©ãƒ¢ãƒ¼ãƒ‰</button>
            <button class="tab" data-tab="execute">å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰</button>
            <button class="tab" data-tab="oneclick">ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰</button>
            <button class="tab" data-tab="format">åˆ—æ•´å½¢ãƒ¢ãƒ¼ãƒ‰</button>
            <button class="tab" data-tab="log">å®Ÿè¡Œãƒ­ã‚°</button>
        </div>

        <!-- å®šç¾©ãƒ¢ãƒ¼ãƒ‰ -->
        <div id="define-tab" class="tab-content active">
            <div class="section">
                <div class="section-title">ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
                <button class="btn btn-secondary btn-sm" id="define-new" style="margin-bottom: 15px;">ğŸ†• æ–°è¦ä½œæˆ</button>
                <div class="two-column">
                    <div class="form-group">
                        <label class="form-label">CSV A</label>
                        <div class="file-input-wrapper">
                            <div class="file-drop-zone" id="define-drop-zone-a">
                                <label class="file-input-button">
                                    ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                                    <input type="file" id="define-file-a" accept=".csv">
                                </label>
                                <div class="file-drop-hint">ã¾ãŸã¯ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                                <span class="file-name" id="define-file-a-name">æœªé¸æŠ</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">CSV B</label>
                        <div class="file-input-wrapper">
                            <div class="file-drop-zone" id="define-drop-zone-b">
                                <label class="file-input-button">
                                    ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                                    <input type="file" id="define-file-b" accept=".csv">
                                </label>
                                <div class="file-drop-hint">ã¾ãŸã¯ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                                <span class="file-name" id="define-file-b-name">æœªé¸æŠ</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="define-preview-section" style="display: none;">
                <div class="section">
                    <div class="section-title">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå…ˆé ­4è¡Œï¼‰</div>
                    <div class="two-column">
                        <div>
                            <strong>CSV A</strong>
                            <div id="define-preview-a"></div>
                        </div>
                        <div>
                            <strong>CSV B</strong>
                            <div id="define-preview-b"></div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">çµåˆè¨­å®š</div>
                    <div class="two-column">
                        <div class="form-group">
                            <label class="form-label">Aå´ã®çµåˆã‚­ãƒ¼</label>
                            <select id="define-key-a" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Bå´ã®çµåˆã‚­ãƒ¼</label>
                            <select id="define-key-b" class="form-control"></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">çµåˆæ–¹æ³•</label>
                        <select id="define-join-type" class="form-control">
                            <option value="inner">ä¸¡æ–¹ã«ä¸€è‡´ã™ã‚‹è¡Œã ã‘å‡ºåŠ›</option>
                            <option value="left">Aã‚’åŸºæº–ã«Bã‚’è£œå®Œ</option>
                            <option value="right">Bã‚’åŸºæº–ã«Aã‚’è£œå®Œ</option>
                            <option value="outer">ã™ã¹ã¦ã®è¡Œã‚’å‡ºåŠ›ï¼ˆå…¨çµåˆï¼‰</option>
                        </select>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">å‡ºåŠ›ã‚«ãƒ©ãƒ è¨­å®š</div>
                    <div id="define-columns" class="column-list"></div>
                </div>

                <div class="section">
                    <div class="section-title">ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›ãƒ«ãƒ¼ãƒ«</div>
                    <div id="define-rules" class="rule-list"></div>
                    <button class="btn btn-secondary btn-sm" id="define-add-rule" style="margin-top: 10px;">+ ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ </button>
                </div>

                <div class="section">
                    <div class="section-title">ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼è¨­å®š</div>
                    <div class="validation-options">
                        <div class="checkbox-group">
                            <input type="checkbox" id="define-check-blank" checked>
                            <label for="define-check-blank">ç©ºç™½ã‚­ãƒ¼ãƒã‚§ãƒƒã‚¯</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="define-check-duplicate">
                            <label for="define-check-duplicate">é‡è¤‡ã‚­ãƒ¼ãƒã‚§ãƒƒã‚¯</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="define-check-column-count">
                            <label for="define-check-column-count">ã‚«ãƒ©ãƒ æ•°ä¸ä¸€è‡´ãƒã‚§ãƒƒã‚¯</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="define-remove-duplicates">
                            <label for="define-remove-duplicates">é‡è¤‡è¡Œé™¤å»</label>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">è¨­å®šã®ä¿å­˜</div>
                    <div class="form-group">
                        <label class="form-label">è¨­å®šå</label>
                        <input type="text" id="define-setting-name" class="form-control" placeholder="è¨­å®šåã‚’å…¥åŠ›">
                    </div>
                    <div class="checkbox-group" style="margin-bottom: 15px;">
                        <input type="checkbox" id="define-save-csv-data">
                        <label for="define-save-csv-data">CSVãƒ‡ãƒ¼ã‚¿ã‚‚ä¿å­˜ï¼ˆãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯å®Ÿè¡Œã§å†åˆ©ç”¨å¯èƒ½ï¼‰</label>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-success" id="define-save-setting">è¨­å®šã‚’ä¿å­˜</button>
                        <button class="btn btn-primary" id="define-test-run">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
                        <button class="btn btn-secondary" id="define-export-setting">è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                        <button class="btn btn-secondary" id="define-import-setting">è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                        <input type="file" id="define-import-file" accept=".json" style="display: none;">
                    </div>
                </div>

                <div id="define-test-result-section" style="display: none;">
                    <div class="section">
                        <div class="section-title">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ</div>
                        <div id="define-test-result-summary" class="result-summary"></div>
                        <div id="define-test-result-preview"></div>
                        <button class="btn btn-success" id="define-test-download" style="margin-top: 15px;">CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    </div>
                </div>

                <div class="section" id="define-saved-settings-section" style="display: none;">
                    <div class="section-title">ä¿å­˜æ¸ˆã¿è¨­å®š</div>
                    <div id="define-saved-settings" class="settings-list"></div>
                </div>
            </div>
        </div>

        <!-- å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ -->
        <div id="execute-tab" class="tab-content">
            <div class="section">
                <div class="section-title">è¨­å®šã®é¸æŠ</div>
                <div class="form-group">
                    <label class="form-label">ä¿å­˜æ¸ˆã¿è¨­å®š</label>
                    <select id="execute-setting" class="form-control">
                        <option value="">è¨­å®šã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>
                <div id="execute-summary" class="summary-box" style="display: none;"></div>
            </div>

            <div id="execute-file-section" style="display: none;">
                <div class="section">
                    <div class="section-title">ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
                    <div class="two-column">
                        <div class="form-group">
                            <label class="form-label">CSV A</label>
                            <div class="file-input-wrapper">
                                <div class="file-drop-zone" id="execute-drop-zone-a">
                                    <label class="file-input-button">
                                        ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                                        <input type="file" id="execute-file-a" accept=".csv">
                                    </label>
                                    <div class="file-drop-hint">ã¾ãŸã¯ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                                    <span class="file-name" id="execute-file-a-name">æœªé¸æŠ</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">CSV B</label>
                            <div class="file-input-wrapper">
                                <div class="file-drop-zone" id="execute-drop-zone-b">
                                    <label class="file-input-button">
                                        ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                                        <input type="file" id="execute-file-b" accept=".csv">
                                    </label>
                                    <div class="file-drop-hint">ã¾ãŸã¯ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                                    <span class="file-name" id="execute-file-b-name">æœªé¸æŠ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="execute-run">â–¶ å¤‰æ›ã‚’å®Ÿè¡Œ</button>
                </div>

                <div id="execute-result-section" style="display: none;">
                    <div class="section">
                        <div class="section-title">å®Ÿè¡Œçµæœ</div>
                        <div id="execute-result-summary" class="result-summary"></div>
                        <div id="execute-result-preview"></div>
                        <button class="btn btn-success" id="execute-download" style="margin-top: 15px;">CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ -->
        <div id="oneclick-tab" class="tab-content">
            <div id="oneclick-no-data" class="section" style="display: none;">
                <div class="alert alert-info">
                    â„¹ï¸ ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ã¾ãšã€Œå®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ã€ã§CSVçµåˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚<br>
                    ç›´å‰ã«å®Ÿè¡Œã—ãŸæ“ä½œã‚’ä¿æŒã—ã€ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§åŒã˜å‡¦ç†ã‚’å†å®Ÿè¡Œã§ãã¾ã™ã€‚
                </div>
                <button class="btn btn-primary" onclick="document.querySelector('[data-tab=execute]').click()">å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ã¸ç§»å‹•</button>
            </div>

            <div id="oneclick-with-data" class="section" style="display: none;">
                <div class="section-title">ç›´å‰ã®å®Ÿè¡Œæƒ…å ±</div>
                <div id="oneclick-info" class="summary-box"></div>
                <button class="btn btn-primary btn-lg" id="oneclick-run" style="font-size: 18px; padding: 15px 40px; margin-top: 20px;">âš¡ ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯å†å®Ÿè¡Œ</button>
                <p style="margin-top: 15px; color: #6c757d; font-size: 14px;">
                    åŒã˜è¨­å®šã¨ãƒ•ã‚¡ã‚¤ãƒ«ã§ã€å³åº§ã«å¤‰æ›ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
                </p>
            </div>
        </div>

        <!-- åˆ—æ•´å½¢ãƒ¢ãƒ¼ãƒ‰ -->
        <div id="format-tab" class="tab-content">
            <div class="section">
                <div class="section-title">ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
                <div class="form-group">
                    <label class="form-label">CSVãƒ•ã‚¡ã‚¤ãƒ«</label>
                    <div class="file-input-wrapper">
                        <div class="file-drop-zone" id="format-drop-zone">
                            <label class="file-input-button">
                                ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                                <input type="file" id="format-file" accept=".csv">
                            </label>
                            <div class="file-drop-hint">ã¾ãŸã¯ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                            <span class="file-name" id="format-file-name">æœªé¸æŠ</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="format-columns-section" style="display: none;">
                <div class="section">
                    <div class="section-title">åˆ—è¨­å®š</div>
                    <div id="format-columns" class="column-list"></div>
                </div>

                <div class="section">
                    <div class="section-title">æ•´å½¢è¨­å®šã®ä¿å­˜</div>
                    <div class="form-group">
                        <label class="form-label">è¨­å®šå</label>
                        <input type="text" id="format-setting-name" class="form-control" placeholder="è¨­å®šåã‚’å…¥åŠ›">
                    </div>
                    <div class="button-group">
                        <button class="btn btn-success" id="format-save-setting">è¨­å®šã‚’ä¿å­˜</button>
                        <button class="btn btn-secondary" id="format-export-setting">è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                        <button class="btn btn-secondary" id="format-import-setting">è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                        <input type="file" id="format-import-file" accept=".json" style="display: none;">
                        <button class="btn btn-primary" id="format-run">æ•´å½¢ã—ã¦å‡ºåŠ›</button>
                    </div>
                </div>

                <div class="section" id="format-saved-settings-section" style="display: none;">
                    <div class="section-title">ä¿å­˜æ¸ˆã¿è¨­å®š</div>
                    <div id="format-saved-settings" class="settings-list"></div>
                </div>
            </div>
        </div>

        <!-- å®Ÿè¡Œãƒ­ã‚° -->
        <div id="log-tab" class="tab-content">
            <div class="section">
                <div class="section-title">å®Ÿè¡Œå±¥æ­´</div>
                <button class="btn btn-danger btn-sm" id="log-clear-all" style="margin-bottom: 15px;">å…¨å‰Šé™¤</button>
                <div id="log-list"></div>
            </div>
        </div>
    </div>

    <!-- è­¦å‘Šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="warning-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">âš ï¸ è­¦å‘Š</div>
            <div class="modal-body" id="warning-modal-body"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="warning-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" id="warning-proceed">ã“ã®ã¾ã¾å®Ÿè¡Œ</button>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let csvDataA = null;
        let csvDataB = null;
        let currentColumns = [];
        let conversionRules = [];
        let resultCsvData = null;
        let formatCsvData = null;
        let formatColumns = [];
        let currentDefineFileNames = { a: '', b: '' };

        // å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ä¿æŒ
        let executeFileA = null;
        let executeFileB = null;

        // ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ç”¨ã®æœ€å¾Œã®å®Ÿè¡Œæƒ…å ±
        let lastExecutionData = null;

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const result = [];

            for (let line of lines) {
                const row = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const next = line[i + 1];

                    if (char === '"') {
                        if (inQuotes && next === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        row.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                row.push(current);
                result.push(row);
            }

            return result;
        }

        function csvToString(data) {
            return data.map(row => {
                return row.map(cell => {
                    const str = String(cell || '');
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                }).join(',');
            }).join('\n');
        }

        function encodeCSVData(csvData) {
            const csvString = csvToString(csvData);
            return btoa(unescape(encodeURIComponent(csvString)));
        }

        function decodeCSVData(base64String) {
            const csvString = decodeURIComponent(escape(atob(base64String)));
            return parseCSV(csvString);
        }

        function getCSVDataSize(csvData) {
            const csvString = csvToString(csvData);
            return new Blob([csvString]).size;
        }

        function downloadCSV(data, filename) {
            const csvString = csvToString(data);
            const bom = '\uFEFF';
            const blob = new Blob([bom + csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        function formatDateTime(date) {
            const pad = (n) => String(n).padStart(2, '0');
            return `${date.getFullYear()}${pad(date.getMonth() + 1)}${pad(date.getDate())}${pad(date.getHours())}${pad(date.getMinutes())}${pad(date.getSeconds())}`;
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;

                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');

                if (tabName === 'execute') {
                    loadSettingsDropdown(tabName);
                } else if (tabName === 'oneclick') {
                    loadOneclickMode();
                } else if (tabName === 'log') {
                    loadExecutionLog();
                } else if (tabName === 'define') {
                    loadSavedSettings();
                } else if (tabName === 'format') {
                    loadFormatSettings();
                }
            });
        });

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã®æ±ç”¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupFileDrop(dropZoneId, fileInputId, fileNameId, onFileLoaded) {
            const dropZone = document.getElementById(dropZoneId);
            const fileInput = document.getElementById(fileInputId);

            if (!dropZone || !fileInput) return;

            // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
            dropZone.addEventListener('click', (e) => {
                if (e.target === fileInput || fileInput.contains(e.target)) return;
                fileInput.click();
            });

            // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('drag-over');
            });

            // ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('drag-over');
            });

            // ãƒ‰ãƒ­ãƒƒãƒ—
            dropZone.addEventListener('drop', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('drag-over');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.name.endsWith('.csv')) {
                        document.getElementById(fileNameId).textContent = file.name;
                        const text = await readFile(file);
                        onFileLoaded(file, text);
                    } else {
                        alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    }
                }
            });
        }

        // å®šç¾©ãƒ¢ãƒ¼ãƒ‰: æ–°è¦ä½œæˆ
        document.getElementById('define-new').addEventListener('click', () => {
            if (csvDataA || csvDataB) {
                if (!confirm('ç¾åœ¨ã®å®šç¾©å†…å®¹ã‚’ã‚¯ãƒªã‚¢ã—ã¦æ–°è¦ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) {
                    return;
                }
            }

            // ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªã‚¢
            csvDataA = null;
            csvDataB = null;
            currentDefineFileNames = { a: '', b: '' };
            currentColumns = [];
            conversionRules = [];

            // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã®ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('define-file-a').value = '';
            document.getElementById('define-file-b').value = '';
            document.getElementById('define-file-a-name').textContent = 'æœªé¸æŠ';
            document.getElementById('define-file-b-name').textContent = 'æœªé¸æŠ';

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
            document.getElementById('define-preview-section').style.display = 'none';

            // è¨­å®šåã‚’ã‚¯ãƒªã‚¢
            document.getElementById('define-setting-name').value = '';

            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«
            document.getElementById('define-check-blank').checked = true;
            document.getElementById('define-check-duplicate').checked = false;
            document.getElementById('define-check-column-count').checked = false;
            document.getElementById('define-remove-duplicates').checked = false;

            alert('å®šç¾©ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚æ–°ã—ã„å®šç¾©ã‚’ä½œæˆã§ãã¾ã™ã€‚');
        });

        // å®šç¾©ãƒ¢ãƒ¼ãƒ‰: ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        document.getElementById('define-file-a').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                currentDefineFileNames.a = file.name;
                document.getElementById('define-file-a-name').textContent = file.name;
                const text = await readFile(file);
                csvDataA = parseCSV(text);
                updateDefinePreview();
            }
        });

        document.getElementById('define-file-b').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                currentDefineFileNames.b = file.name;
                document.getElementById('define-file-b-name').textContent = file.name;
                const text = await readFile(file);
                csvDataB = parseCSV(text);
                updateDefinePreview();
            }
        });

        // å®šç¾©ãƒ¢ãƒ¼ãƒ‰: ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        setupFileDrop('define-drop-zone-a', 'define-file-a', 'define-file-a-name', (file, text) => {
            currentDefineFileNames.a = file.name;
            csvDataA = parseCSV(text);
            updateDefinePreview();
        });

        setupFileDrop('define-drop-zone-b', 'define-file-b', 'define-file-b-name', (file, text) => {
            currentDefineFileNames.b = file.name;
            csvDataB = parseCSV(text);
            updateDefinePreview();
        });

        function updateDefinePreview() {
            if (!csvDataA || !csvDataB) return;

            document.getElementById('define-preview-section').style.display = 'block';

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            document.getElementById('define-preview-a').innerHTML = createPreviewTable(csvDataA.slice(0, 5));
            document.getElementById('define-preview-b').innerHTML = createPreviewTable(csvDataB.slice(0, 5));

            // çµåˆã‚­ãƒ¼é¸æŠè‚¢ã®è¨­å®š
            const keySelectA = document.getElementById('define-key-a');
            const keySelectB = document.getElementById('define-key-b');

            keySelectA.innerHTML = csvDataA[0].map((col, i) => `<option value="${i}">${col}</option>`).join('');
            keySelectB.innerHTML = csvDataB[0].map((col, i) => `<option value="${i}">${col}</option>`).join('');

            // ã‚«ãƒ©ãƒ ä¸€è¦§ã®æ›´æ–°
            updateColumnList();
        }

        function createPreviewTable(data) {
            if (!data || data.length === 0) return '';

            let html = '<table class="preview-table"><thead><tr>';
            data[0].forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead><tbody>';

            for (let i = 1; i < data.length; i++) {
                html += '<tr>';
                data[i].forEach(cell => {
                    html += `<td>${cell || ''}</td>`;
                });
                html += '</tr>';
            }

            html += '</tbody></table>';
            return html;
        }

        function updateColumnList() {
            if (!csvDataA || !csvDataB) return;

            const headersA = csvDataA[0];
            const headersB = csvDataB[0];

            currentColumns = [
                ...headersA.map((name, index) => ({ source: 'A', original: name, name, index, selected: true })),
                ...headersB.map((name, index) => ({ source: 'B', original: name, name, index, selected: true }))
            ];

            renderColumnList();
        }

        function renderColumnList() {
            const container = document.getElementById('define-columns');
            container.innerHTML = '';

            currentColumns.forEach((col, idx) => {
                const div = document.createElement('div');
                div.className = 'column-item';
                div.draggable = true;
                div.dataset.index = idx;

                div.innerHTML = `
                    <span class="drag-handle">â˜°</span>
                    <input type="checkbox" class="column-checkbox" ${col.selected ? 'checked' : ''}>
                    <span class="column-source">${col.source}</span>
                    <span class="column-name">${col.original}</span>
                    <input type="text" class="column-rename" value="${col.name}" placeholder="ãƒªãƒãƒ¼ãƒ ">
                `;

                // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
                div.querySelector('.column-checkbox').addEventListener('change', (e) => {
                    currentColumns[idx].selected = e.target.checked;
                });

                // ãƒªãƒãƒ¼ãƒ 
                div.querySelector('.column-rename').addEventListener('input', (e) => {
                    currentColumns[idx].name = e.target.value || col.original;
                });

                // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dragover', handleDragOver);
                div.addEventListener('drop', handleDrop);
                div.addEventListener('dragend', handleDragEnd);

                container.appendChild(div);
            });
        }

        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';

            const items = Array.from(document.querySelectorAll('.column-item'));
            items.forEach(item => item.classList.remove('drag-over'));

            if (this !== draggedElement) {
                this.classList.add('drag-over');
            }

            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedElement !== this) {
                const fromIndex = parseInt(draggedElement.dataset.index);
                const toIndex = parseInt(this.dataset.index);

                const item = currentColumns.splice(fromIndex, 1)[0];
                currentColumns.splice(toIndex, 0, item);

                renderColumnList();
            }

            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.column-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        // å¤‰æ›ãƒ«ãƒ¼ãƒ«
        document.getElementById('define-add-rule').addEventListener('click', () => {
            conversionRules.push({ column: '', from: '', to: '' });
            renderRuleList();
        });

        function renderRuleList() {
            const container = document.getElementById('define-rules');
            container.innerHTML = '';

            conversionRules.forEach((rule, idx) => {
                const div = document.createElement('div');
                div.className = 'rule-item';

                const columnOptions = currentColumns
                    .filter(col => col.selected)
                    .map(col => `<option value="${col.name}" ${rule.column === col.name ? 'selected' : ''}>${col.name}</option>`)
                    .join('');

                div.innerHTML = `
                    <select class="rule-column">
                        <option value="">ã‚«ãƒ©ãƒ ã‚’é¸æŠ</option>
                        ${columnOptions}
                    </select>
                    <input type="text" class="rule-from" value="${rule.from}" placeholder="å¤‰æ›å‰">
                    <input type="text" class="rule-to" value="${rule.to}" placeholder="å¤‰æ›å¾Œ">
                    <button class="btn btn-danger btn-sm rule-delete">å‰Šé™¤</button>
                `;

                div.querySelector('.rule-column').addEventListener('change', (e) => {
                    conversionRules[idx].column = e.target.value;
                });

                div.querySelector('.rule-from').addEventListener('input', (e) => {
                    conversionRules[idx].from = e.target.value;
                });

                div.querySelector('.rule-to').addEventListener('input', (e) => {
                    conversionRules[idx].to = e.target.value;
                });

                div.querySelector('.rule-delete').addEventListener('click', () => {
                    conversionRules.splice(idx, 1);
                    renderRuleList();
                });

                container.appendChild(div);
            });
        }

        // è¨­å®šã®ä¿å­˜
        document.getElementById('define-save-setting').addEventListener('click', () => {
            const name = document.getElementById('define-setting-name').value.trim();
            if (!name) {
                alert('è¨­å®šåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const saveCsvData = document.getElementById('define-save-csv-data').checked;

            // CSVãƒ‡ãƒ¼ã‚¿ã®ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
            if (saveCsvData && csvDataA && csvDataB) {
                const sizeA = getCSVDataSize(csvDataA);
                const sizeB = getCSVDataSize(csvDataB);
                const totalSize = sizeA + sizeB;

                if (totalSize > 100 * 1024) { // 100KB
                    const sizeKB = Math.round(totalSize / 1024);
                    if (!confirm(`è­¦å‘Š: CSVãƒ‡ãƒ¼ã‚¿ã®ã‚µã‚¤ã‚ºãŒ ${sizeKB}KB ã¨å¤§ãã„ãŸã‚ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ã‚’åœ§è¿«ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n\nãã‚Œã§ã‚‚ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        return;
                    }
                }
            }

            const setting = {
                name,
                fileNameA: currentDefineFileNames.a,
                fileNameB: currentDefineFileNames.b,
                keyA: document.getElementById('define-key-a').value,
                keyB: document.getElementById('define-key-b').value,
                joinType: document.getElementById('define-join-type').value,
                columns: currentColumns,
                rules: conversionRules,
                validation: {
                    checkBlank: document.getElementById('define-check-blank').checked,
                    checkDuplicate: document.getElementById('define-check-duplicate').checked,
                    checkColumnCount: document.getElementById('define-check-column-count').checked,
                    removeDuplicates: document.getElementById('define-remove-duplicates').checked
                },
                csvDataA: (saveCsvData && csvDataA) ? encodeCSVData(csvDataA) : null,
                csvDataB: (saveCsvData && csvDataB) ? encodeCSVData(csvDataB) : null
            };

            const settings = JSON.parse(localStorage.getItem('csvSettings') || '[]');
            const existingIndex = settings.findIndex(s => s.name === name);

            if (existingIndex >= 0) {
                if (!confirm('åŒåã®è¨­å®šãŒå­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ')) return;
                settings[existingIndex] = setting;
            } else {
                settings.push(setting);
            }

            localStorage.setItem('csvSettings', JSON.stringify(settings));
            alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            loadSavedSettings();
        });

        function loadSavedSettings() {
            const settings = JSON.parse(localStorage.getItem('csvSettings') || '[]');
            const container = document.getElementById('define-saved-settings');

            if (settings.length === 0) {
                document.getElementById('define-saved-settings-section').style.display = 'none';
                return;
            }

            document.getElementById('define-saved-settings-section').style.display = 'block';
            container.innerHTML = '';

            settings.forEach((setting, idx) => {
                const div = document.createElement('div');
                div.className = 'settings-item';

                div.innerHTML = `
                    <span class="settings-name">${setting.name}</span>
                    <div class="button-group">
                        <button class="btn btn-primary btn-sm settings-load">èª­è¾¼</button>
                        <button class="btn btn-danger btn-sm settings-delete">å‰Šé™¤</button>
                    </div>
                `;

                div.querySelector('.settings-load').addEventListener('click', () => {
                    loadSetting(setting);
                });

                div.querySelector('.settings-delete').addEventListener('click', () => {
                    if (confirm(`è¨­å®šã€Œ${setting.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        settings.splice(idx, 1);
                        localStorage.setItem('csvSettings', JSON.stringify(settings));
                        loadSavedSettings();
                    }
                });

                container.appendChild(div);
            });
        }

        function loadSetting(setting) {
            // ãƒ•ã‚¡ã‚¤ãƒ«åã®å¾©å…ƒ
            currentDefineFileNames = { a: setting.fileNameA || '', b: setting.fileNameB || '' };

            // ä¿å­˜ã•ã‚ŒãŸCSVãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯å¾©å…ƒ
            if (setting.csvDataA && setting.csvDataB) {
                try {
                    csvDataA = decodeCSVData(setting.csvDataA);
                    csvDataB = decodeCSVData(setting.csvDataB);

                    document.getElementById('define-file-a-name').textContent = setting.fileNameA || 'ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿';
                    document.getElementById('define-file-b-name').textContent = setting.fileNameB || 'ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿';

                    updateDefinePreview();
                } catch (err) {
                    alert('ä¿å­˜ã•ã‚ŒãŸCSVãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ');
                    console.error(err);
                    return;
                }
            }

            // UIã¸ã®åæ˜ ã¯ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿
            if (csvDataA && csvDataB) {
                document.getElementById('define-key-a').value = setting.keyA;
                document.getElementById('define-key-b').value = setting.keyB;
                document.getElementById('define-join-type').value = setting.joinType;
                currentColumns = setting.columns;
                conversionRules = setting.rules;

                document.getElementById('define-check-blank').checked = setting.validation.checkBlank;
                document.getElementById('define-check-duplicate').checked = setting.validation.checkDuplicate;
                document.getElementById('define-check-column-count').checked = setting.validation.checkColumnCount;
                document.getElementById('define-remove-duplicates').checked = setting.validation.removeDuplicates;

                renderColumnList();
                renderRuleList();

                alert('è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
            } else {
                alert('è¨­å®šã‚’èª­ã¿è¾¼ã‚€ã«ã¯ã€ã¾ãšCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„');
            }
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        document.getElementById('define-export-setting').addEventListener('click', () => {
            const name = document.getElementById('define-setting-name').value.trim();
            if (!name) {
                alert('è¨­å®šåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const setting = {
                name,
                fileNameA: currentDefineFileNames.a,
                fileNameB: currentDefineFileNames.b,
                keyA: document.getElementById('define-key-a').value,
                keyB: document.getElementById('define-key-b').value,
                joinType: document.getElementById('define-join-type').value,
                columns: currentColumns,
                rules: conversionRules,
                validation: {
                    checkBlank: document.getElementById('define-check-blank').checked,
                    checkDuplicate: document.getElementById('define-check-duplicate').checked,
                    checkColumnCount: document.getElementById('define-check-column-count').checked,
                    removeDuplicates: document.getElementById('define-remove-duplicates').checked
                }
            };

            const json = JSON.stringify(setting, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${name}.json`;
            link.click();
        });

        document.getElementById('define-import-setting').addEventListener('click', () => {
            document.getElementById('define-import-file').click();
        });

        document.getElementById('define-import-file').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const text = await readFile(file);
                const setting = JSON.parse(text);

                const settings = JSON.parse(localStorage.getItem('csvSettings') || '[]');
                const existingIndex = settings.findIndex(s => s.name === setting.name);

                if (existingIndex >= 0) {
                    if (!confirm('åŒåã®è¨­å®šãŒå­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ')) return;
                    settings[existingIndex] = setting;
                } else {
                    settings.push(setting);
                }

                localStorage.setItem('csvSettings', JSON.stringify(settings));
                alert('è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
                loadSavedSettings();
            } catch (err) {
                alert('è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }

            e.target.value = '';
        });

        // å®šç¾©ãƒ¢ãƒ¼ãƒ‰ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        document.getElementById('define-test-run').addEventListener('click', () => {
            if (!csvDataA || !csvDataB) {
                alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„');
                return;
            }

            const setting = {
                name: 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ',
                fileNameA: currentDefineFileNames.a,
                fileNameB: currentDefineFileNames.b,
                keyA: document.getElementById('define-key-a').value,
                keyB: document.getElementById('define-key-b').value,
                joinType: document.getElementById('define-join-type').value,
                columns: currentColumns,
                rules: conversionRules,
                validation: {
                    checkBlank: document.getElementById('define-check-blank').checked,
                    checkDuplicate: document.getElementById('define-check-duplicate').checked,
                    checkColumnCount: document.getElementById('define-check-column-count').checked,
                    removeDuplicates: document.getElementById('define-remove-duplicates').checked
                }
            };

            performDefineTestRun(csvDataA, csvDataB, setting);
        });

        function performDefineTestRun(dataA, dataB, setting) {
            const warnings = validateData(dataA, dataB, setting);

            if (warnings.length > 0) {
                showWarningModal(warnings, () => {
                    executeDefineTestRun(dataA, dataB, setting);
                });
            } else {
                executeDefineTestRun(dataA, dataB, setting);
            }
        }

        function executeDefineTestRun(dataA, dataB, setting) {
            const headersA = dataA[0];
            const headersB = dataB[0];
            const keyA = parseInt(setting.keyA);
            const keyB = parseInt(setting.keyB);
            const joinType = setting.joinType;

            // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒãƒ—ã«å¤‰æ›
            const mapB = new Map();
            for (let i = 1; i < dataB.length; i++) {
                const key = dataB[i][keyB];
                if (!mapB.has(key)) {
                    mapB.set(key, []);
                }
                mapB.get(key).push(dataB[i]);
            }

            const result = [];
            const matchedKeysB = new Set();

            // å‡ºåŠ›ãƒ˜ãƒƒãƒ€ãƒ¼
            const outputHeaders = setting.columns
                .filter(col => col.selected)
                .map(col => col.name);
            result.push(outputHeaders);

            // Inner/Left/Outer Join
            if (joinType === 'inner' || joinType === 'left' || joinType === 'outer') {
                for (let i = 1; i < dataA.length; i++) {
                    const rowA = dataA[i];
                    const key = rowA[keyA];
                    const rowsB = mapB.get(key) || [];

                    if (rowsB.length > 0) {
                        rowsB.forEach(rowB => {
                            const outputRow = setting.columns
                                .filter(col => col.selected)
                                .map(col => {
                                    if (col.source === 'A') {
                                        return rowA[col.index] || '';
                                    } else {
                                        return rowB[col.index] || '';
                                    }
                                });
                            result.push(outputRow);
                        });
                        matchedKeysB.add(key);
                    } else if (joinType === 'left' || joinType === 'outer') {
                        const outputRow = setting.columns
                            .filter(col => col.selected)
                            .map(col => {
                                if (col.source === 'A') {
                                    return rowA[col.index] || '';
                                } else {
                                    return '';
                                }
                            });
                        result.push(outputRow);
                    }
                }
            }

            // Right Join
            if (joinType === 'right') {
                const mapA = new Map();
                for (let i = 1; i < dataA.length; i++) {
                    const key = dataA[i][keyA];
                    if (!mapA.has(key)) {
                        mapA.set(key, []);
                    }
                    mapA.get(key).push(dataA[i]);
                }

                for (let i = 1; i < dataB.length; i++) {
                    const rowB = dataB[i];
                    const key = rowB[keyB];
                    const rowsA = mapA.get(key) || [];

                    if (rowsA.length > 0) {
                        rowsA.forEach(rowA => {
                            const outputRow = setting.columns
                                .filter(col => col.selected)
                                .map(col => {
                                    if (col.source === 'A') {
                                        return rowA[col.index] || '';
                                    } else {
                                        return rowB[col.index] || '';
                                    }
                                });
                            result.push(outputRow);
                        });
                    } else {
                        const outputRow = setting.columns
                            .filter(col => col.selected)
                            .map(col => {
                                if (col.source === 'B') {
                                    return rowB[col.index] || '';
                                } else {
                                    return '';
                                }
                            });
                        result.push(outputRow);
                    }
                }
            }

            // Outer Join
            if (joinType === 'outer') {
                for (let i = 1; i < dataB.length; i++) {
                    const rowB = dataB[i];
                    const key = rowB[keyB];

                    if (matchedKeysB.has(key)) {
                        continue;
                    }

                    const outputRow = setting.columns
                        .filter(col => col.selected)
                        .map(col => {
                            if (col.source === 'B') {
                                return rowB[col.index] || '';
                            } else {
                                return '';
                            }
                        });
                    result.push(outputRow);
                }
            }

            // å¤‰æ›ãƒ«ãƒ¼ãƒ«é©ç”¨
            applyConversionRules(result, setting.rules);

            // é‡è¤‡è¡Œé™¤å»
            let removedCount = 0;
            if (setting.validation.removeDuplicates) {
                const beforeCount = result.length - 1;
                result.splice(1, result.length - 1, ...removeDuplicates(result.slice(1)));
                removedCount = beforeCount - (result.length - 1);
            }

            resultCsvData = result;

            // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœã®è¡¨ç¤º
            displayDefineTestResult(result, removedCount);
        }

        function displayDefineTestResult(data, removedCount) {
            const summary = document.getElementById('define-test-result-summary');
            summary.innerHTML = `
                <div class="result-summary-item"><strong>å‡ºåŠ›è¡Œæ•°:</strong> ${data.length - 1}è¡Œ</div>
                <div class="result-summary-item"><strong>å‡ºåŠ›ã‚«ãƒ©ãƒ æ•°:</strong> ${data[0].length}åˆ—</div>
                ${removedCount > 0 ? `<div class="result-summary-item"><strong>é‡è¤‡é™¤å»:</strong> ${removedCount}è¡Œ</div>` : ''}
            `;

            const preview = document.getElementById('define-test-result-preview');
            preview.innerHTML = '<strong>å…ˆé ­20è¡Œã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</strong>' + createPreviewTable(data.slice(0, 21));

            document.getElementById('define-test-result-section').style.display = 'block';

            // ã‚¹ãƒ ãƒ¼ã‚ºã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            document.getElementById('define-test-result-section').scrollIntoView({ behavior: 'smooth' });
        }

        document.getElementById('define-test-download').addEventListener('click', () => {
            if (!resultCsvData) return;
            const timestamp = formatDateTime(new Date());
            downloadCSV(resultCsvData, `test_result_${timestamp}.csv`);
        });

        // å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰
        function loadSettingsDropdown(mode) {
            const settings = JSON.parse(localStorage.getItem('csvSettings') || '[]');
            const select = document.getElementById(`${mode}-setting`);

            select.innerHTML = '<option value="">è¨­å®šã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            settings.forEach((setting, idx) => {
                const option = document.createElement('option');
                option.value = idx;
                option.textContent = setting.name;
                select.appendChild(option);
            });
        }

        document.getElementById('execute-setting').addEventListener('change', (e) => {
            const idx = e.target.value;
            if (idx === '') {
                document.getElementById('execute-file-section').style.display = 'none';
                document.getElementById('execute-summary').style.display = 'none';
                return;
            }

            const settings = JSON.parse(localStorage.getItem('csvSettings') || '[]');
            const setting = settings[idx];

            // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
            const joinTypeNames = {
                'inner': 'ä¸¡æ–¹ã«ä¸€è‡´ã™ã‚‹è¡Œã ã‘å‡ºåŠ›',
                'left': 'Aã‚’åŸºæº–ã«Bã‚’è£œå®Œ',
                'right': 'Bã‚’åŸºæº–ã«Aã‚’è£œå®Œ',
                'outer': 'ã™ã¹ã¦ã®è¡Œã‚’å‡ºåŠ›ï¼ˆå…¨çµåˆï¼‰'
            };

            document.getElementById('execute-summary').innerHTML = `
                <div class="summary-item"><strong>è¨­å®šå:</strong> ${setting.name}</div>
                <div class="summary-item"><strong>çµåˆæ–¹æ³•:</strong> ${joinTypeNames[setting.joinType]}</div>
                <div class="summary-item"><strong>çµåˆã‚­ãƒ¼:</strong> A: ${setting.columns.find(c => c.source === 'A' && c.index == setting.keyA)?.original || ''} / B: ${setting.columns.find(c => c.source === 'B' && c.index == setting.keyB)?.original || ''}</div>
                <div class="summary-item"><strong>å‡ºåŠ›ã‚«ãƒ©ãƒ æ•°:</strong> ${setting.columns.filter(c => c.selected).length}</div>
            `;
            document.getElementById('execute-summary').style.display = 'block';
            document.getElementById('execute-file-section').style.display = 'block';
            document.getElementById('execute-result-section').style.display = 'none';
        });

        document.getElementById('execute-file-a').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                executeFileA = file;
                document.getElementById('execute-file-a-name').textContent = file.name;
            }
        });

        document.getElementById('execute-file-b').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                executeFileB = file;
                document.getElementById('execute-file-b-name').textContent = file.name;
            }
        });

        // å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰: ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        setupFileDrop('execute-drop-zone-a', 'execute-file-a', 'execute-file-a-name', (file) => {
            executeFileA = file;
        });
        setupFileDrop('execute-drop-zone-b', 'execute-file-b', 'execute-file-b-name', (file) => {
            executeFileB = file;
        });

        document.getElementById('execute-run').addEventListener('click', async () => {
            const settingIdx = document.getElementById('execute-setting').value;
            if (settingIdx === '') {
                alert('è¨­å®šã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (!executeFileA || !executeFileB) {
                alert('ä¸¡æ–¹ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const settings = JSON.parse(localStorage.getItem('csvSettings') || '[]');
            const setting = settings[settingIdx];

            const textA = await readFile(executeFileA);
            const textB = await readFile(executeFileB);
            const dataA = parseCSV(textA);
            const dataB = parseCSV(textB);

            // æœ€å¾Œã®å®Ÿè¡Œæƒ…å ±ã‚’ä¿å­˜ï¼ˆãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯å®Ÿè¡Œç”¨ï¼‰
            lastExecutionData = {
                setting: setting,
                fileA: executeFileA,
                fileB: executeFileB,
                fileNameA: executeFileA.name,
                fileNameB: executeFileB.name,
                dataA: dataA,
                dataB: dataB
            };

            performJoin(dataA, dataB, setting, false, executeFileA.name, executeFileB.name);
        });

        function performJoin(dataA, dataB, setting, autoDownload = false, fileNameA = '', fileNameB = '') {
            const warnings = validateData(dataA, dataB, setting);

            if (warnings.length > 0) {
                showWarningModal(warnings, () => {
                    executeJoin(dataA, dataB, setting, autoDownload, fileNameA, fileNameB);
                });
            } else {
                executeJoin(dataA, dataB, setting, autoDownload, fileNameA, fileNameB);
            }
        }

        function validateData(dataA, dataB, setting) {
            const warnings = [];

            if (setting.validation.checkBlank) {
                let blankCountA = 0;
                let blankCountB = 0;

                for (let i = 1; i < dataA.length; i++) {
                    if (!dataA[i][setting.keyA] || dataA[i][setting.keyA].trim() === '') {
                        blankCountA++;
                    }
                }

                for (let i = 1; i < dataB.length; i++) {
                    if (!dataB[i][setting.keyB] || dataB[i][setting.keyB].trim() === '') {
                        blankCountB++;
                    }
                }

                if (blankCountA > 0) {
                    warnings.push(`CSV Aã®çµåˆã‚­ãƒ¼ã«ç©ºç™½ãŒ${blankCountA}ä»¶ã‚ã‚Šã¾ã™`);
                }
                if (blankCountB > 0) {
                    warnings.push(`CSV Bã®çµåˆã‚­ãƒ¼ã«ç©ºç™½ãŒ${blankCountB}ä»¶ã‚ã‚Šã¾ã™`);
                }
            }

            if (setting.validation.checkDuplicate) {
                const keysA = new Set();
                let dupCountA = 0;
                for (let i = 1; i < dataA.length; i++) {
                    const key = dataA[i][setting.keyA];
                    if (keysA.has(key)) {
                        dupCountA++;
                    }
                    keysA.add(key);
                }

                const keysB = new Set();
                let dupCountB = 0;
                for (let i = 1; i < dataB.length; i++) {
                    const key = dataB[i][setting.keyB];
                    if (keysB.has(key)) {
                        dupCountB++;
                    }
                    keysB.add(key);
                }

                if (dupCountA > 0) {
                    warnings.push(`CSV Aã®çµåˆã‚­ãƒ¼ã«é‡è¤‡ãŒ${dupCountA}ä»¶ã‚ã‚Šã¾ã™`);
                }
                if (dupCountB > 0) {
                    warnings.push(`CSV Bã®çµåˆã‚­ãƒ¼ã«é‡è¤‡ãŒ${dupCountB}ä»¶ã‚ã‚Šã¾ã™`);
                }
            }

            if (setting.validation.checkColumnCount) {
                const colCountA = dataA[0].length;
                const colCountB = dataB[0].length;

                let mismatchA = 0;
                for (let i = 1; i < dataA.length; i++) {
                    if (dataA[i].length !== colCountA) {
                        mismatchA++;
                    }
                }

                let mismatchB = 0;
                for (let i = 1; i < dataB.length; i++) {
                    if (dataB[i].length !== colCountB) {
                        mismatchB++;
                    }
                }

                if (mismatchA > 0) {
                    warnings.push(`CSV Aã«ã‚«ãƒ©ãƒ æ•°ä¸ä¸€è‡´ã®è¡ŒãŒ${mismatchA}ä»¶ã‚ã‚Šã¾ã™`);
                }
                if (mismatchB > 0) {
                    warnings.push(`CSV Bã«ã‚«ãƒ©ãƒ æ•°ä¸ä¸€è‡´ã®è¡ŒãŒ${mismatchB}ä»¶ã‚ã‚Šã¾ã™`);
                }
            }

            return warnings;
        }

        function showWarningModal(warnings, onProceed) {
            const modal = document.getElementById('warning-modal');
            const body = document.getElementById('warning-modal-body');

            body.innerHTML = '<ul>' + warnings.map(w => `<li>${w}</li>`).join('') + '</ul>';
            modal.classList.add('show');

            const handleCancel = () => {
                modal.classList.remove('show');
                cleanup();
            };

            const handleProceed = () => {
                modal.classList.remove('show');
                onProceed();
                cleanup();
            };

            const cleanup = () => {
                document.getElementById('warning-cancel').removeEventListener('click', handleCancel);
                document.getElementById('warning-proceed').removeEventListener('click', handleProceed);
            };

            document.getElementById('warning-cancel').addEventListener('click', handleCancel);
            document.getElementById('warning-proceed').addEventListener('click', handleProceed);
        }

        function executeJoin(dataA, dataB, setting, autoDownload = false, fileNameA = '', fileNameB = '') {
            const headersA = dataA[0];
            const headersB = dataB[0];
            const keyA = parseInt(setting.keyA);
            const keyB = parseInt(setting.keyB);
            const joinType = setting.joinType;

            // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒãƒ—ã«å¤‰æ›
            const mapB = new Map();
            for (let i = 1; i < dataB.length; i++) {
                const key = dataB[i][keyB];
                if (!mapB.has(key)) {
                    mapB.set(key, []);
                }
                mapB.get(key).push(dataB[i]);
            }

            const result = [];
            const matchedKeysB = new Set();

            // å‡ºåŠ›ãƒ˜ãƒƒãƒ€ãƒ¼
            const outputHeaders = setting.columns
                .filter(col => col.selected)
                .map(col => col.name);
            result.push(outputHeaders);

            // Inner/Left/Outer Join
            if (joinType === 'inner' || joinType === 'left' || joinType === 'outer') {
                for (let i = 1; i < dataA.length; i++) {
                    const rowA = dataA[i];
                    const key = rowA[keyA];
                    const rowsB = mapB.get(key) || [];

                    if (rowsB.length > 0) {
                        rowsB.forEach(rowB => {
                            const outputRow = setting.columns
                                .filter(col => col.selected)
                                .map(col => {
                                    if (col.source === 'A') {
                                        return rowA[col.index] || '';
                                    } else {
                                        return rowB[col.index] || '';
                                    }
                                });
                            result.push(outputRow);
                        });
                        matchedKeysB.add(key);
                    } else if (joinType === 'left' || joinType === 'outer') {
                        const outputRow = setting.columns
                            .filter(col => col.selected)
                            .map(col => {
                                if (col.source === 'A') {
                                    return rowA[col.index] || '';
                                } else {
                                    return '';
                                }
                            });
                        result.push(outputRow);
                    }
                }
            }

            // Right Join
            if (joinType === 'right') {
                // Aå´ã‚’ãƒãƒƒãƒ—ã«å¤‰æ›
                const mapA = new Map();
                for (let i = 1; i < dataA.length; i++) {
                    const key = dataA[i][keyA];
                    if (!mapA.has(key)) {
                        mapA.set(key, []);
                    }
                    mapA.get(key).push(dataA[i]);
                }

                for (let i = 1; i < dataB.length; i++) {
                    const rowB = dataB[i];
                    const key = rowB[keyB];
                    const rowsA = mapA.get(key) || [];

                    if (rowsA.length > 0) {
                        // ãƒãƒƒãƒã™ã‚‹å ´åˆã€Aå´ã¨Bå´ã‚’çµåˆ
                        rowsA.forEach(rowA => {
                            const outputRow = setting.columns
                                .filter(col => col.selected)
                                .map(col => {
                                    if (col.source === 'A') {
                                        return rowA[col.index] || '';
                                    } else {
                                        return rowB[col.index] || '';
                                    }
                                });
                            result.push(outputRow);
                        });
                    } else {
                        // ãƒãƒƒãƒã—ãªã„å ´åˆã€Bå´ã®ã¿å‡ºåŠ›
                        const outputRow = setting.columns
                            .filter(col => col.selected)
                            .map(col => {
                                if (col.source === 'B') {
                                    return rowB[col.index] || '';
                                } else {
                                    return '';
                                }
                            });
                        result.push(outputRow);
                    }
                }
            }

            // Outer Join
            if (joinType === 'outer') {
                for (let i = 1; i < dataB.length; i++) {
                    const rowB = dataB[i];
                    const key = rowB[keyB];

                    if (matchedKeysB.has(key)) {
                        continue;
                    }

                    const outputRow = setting.columns
                        .filter(col => col.selected)
                        .map(col => {
                            if (col.source === 'B') {
                                return rowB[col.index] || '';
                            } else {
                                return '';
                            }
                        });
                    result.push(outputRow);
                }
            }

            // å¤‰æ›ãƒ«ãƒ¼ãƒ«é©ç”¨
            applyConversionRules(result, setting.rules);

            // é‡è¤‡è¡Œé™¤å»
            let removedCount = 0;
            if (setting.validation.removeDuplicates) {
                const beforeCount = result.length - 1;
                result.splice(1, result.length - 1, ...removeDuplicates(result.slice(1)));
                removedCount = beforeCount - (result.length - 1);
            }

            resultCsvData = result;

            // å®Ÿè¡Œãƒ­ã‚°ä¿å­˜
            saveExecutionLog(setting.name, fileNameA, fileNameB, result.length - 1, validateData(dataA, dataB, setting).length > 0, removedCount);

            if (autoDownload) {
                const baseName = setting.name || 'output';
                const timestamp = formatDateTime(new Date());
                downloadCSV(result, `${baseName}_${timestamp}.csv`);
            } else {
                displayResult(result, removedCount);
            }
        }

        function applyConversionRules(data, rules) {
            if (!rules || rules.length === 0) return;

            const headers = data[0];
            const columnIndices = {};
            headers.forEach((header, idx) => {
                columnIndices[header] = idx;
            });

            rules.forEach(rule => {
                if (!rule.column || !rule.from || rule.to === undefined) return;

                const colIdx = columnIndices[rule.column];
                if (colIdx === undefined) return;

                for (let i = 1; i < data.length; i++) {
                    if (data[i][colIdx] === rule.from) {
                        data[i][colIdx] = rule.to;
                    }
                }
            });
        }

        function removeDuplicates(rows) {
            const seen = new Set();
            const unique = [];

            rows.forEach(row => {
                const key = row.join('|');
                if (!seen.has(key)) {
                    seen.add(key);
                    unique.push(row);
                }
            });

            return unique;
        }

        function displayResult(data, removedCount) {
            const summary = document.getElementById('execute-result-summary');
            summary.innerHTML = `
                <div class="result-summary-item"><strong>å‡ºåŠ›è¡Œæ•°:</strong> ${data.length - 1}è¡Œ</div>
                <div class="result-summary-item"><strong>å‡ºåŠ›ã‚«ãƒ©ãƒ æ•°:</strong> ${data[0].length}åˆ—</div>
                ${removedCount > 0 ? `<div class="result-summary-item"><strong>é‡è¤‡é™¤å»:</strong> ${removedCount}è¡Œ</div>` : ''}
            `;

            const preview = document.getElementById('execute-result-preview');
            preview.innerHTML = '<strong>å…ˆé ­20è¡Œã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</strong>' + createPreviewTable(data.slice(0, 21));

            document.getElementById('execute-result-section').style.display = 'block';
        }

        document.getElementById('execute-download').addEventListener('click', () => {
            if (!resultCsvData) return;
            const timestamp = formatDateTime(new Date());
            downloadCSV(resultCsvData, `result_${timestamp}.csv`);
        });

        // ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰
        // ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰: è¡¨ç¤ºæ›´æ–°
        function loadOneclickMode() {
            if (!lastExecutionData) {
                document.getElementById('oneclick-no-data').style.display = 'block';
                document.getElementById('oneclick-with-data').style.display = 'none';
                return;
            }

            document.getElementById('oneclick-no-data').style.display = 'none';
            document.getElementById('oneclick-with-data').style.display = 'block';

            const joinTypeNames = {
                'inner': 'ä¸¡æ–¹ã«ä¸€è‡´ã™ã‚‹è¡Œã ã‘å‡ºåŠ›',
                'left': 'Aã‚’åŸºæº–ã«Bã‚’è£œå®Œ',
                'right': 'Bã‚’åŸºæº–ã«Aã‚’è£œå®Œ',
                'outer': 'ã™ã¹ã¦ã®è¡Œã‚’å‡ºåŠ›ï¼ˆå…¨çµåˆï¼‰'
            };

            document.getElementById('oneclick-info').innerHTML = `
                <div class="summary-item"><strong>è¨­å®šå:</strong> ${lastExecutionData.setting.name}</div>
                <div class="summary-item"><strong>çµåˆæ–¹æ³•:</strong> ${joinTypeNames[lastExecutionData.setting.joinType]}</div>
                <div class="summary-item"><strong>ãƒ•ã‚¡ã‚¤ãƒ«A:</strong> ${lastExecutionData.fileNameA}</div>
                <div class="summary-item"><strong>ãƒ•ã‚¡ã‚¤ãƒ«B:</strong> ${lastExecutionData.fileNameB}</div>
                <div class="summary-item"><strong>å‡ºåŠ›ã‚«ãƒ©ãƒ æ•°:</strong> ${lastExecutionData.setting.columns.filter(c => c.selected).length}åˆ—</div>
            `;
        }

        // ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰: å®Ÿè¡Œãƒœã‚¿ãƒ³
        document.getElementById('oneclick-run').addEventListener('click', async () => {
            if (!lastExecutionData) {
                alert('å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ã§ä¸€åº¦å®Ÿè¡Œã—ã¦ãã ã•ã„');
                return;
            }

            // æœ€å¾Œã®å®Ÿè¡Œã¨åŒã˜è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ã§å†å®Ÿè¡Œ
            performJoin(
                lastExecutionData.dataA,
                lastExecutionData.dataB,
                lastExecutionData.setting,
                true,  // è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                lastExecutionData.fileNameA,
                lastExecutionData.fileNameB
            );
        });

        // åˆ—æ•´å½¢ãƒ¢ãƒ¼ãƒ‰
        document.getElementById('format-file').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('format-file-name').textContent = file.name;
            const text = await readFile(file);
            formatCsvData = parseCSV(text);

            if (formatCsvData.length === 0) return;

            formatColumns = formatCsvData[0].map((name, index) => ({
                original: name,
                name: name,
                index: index,
                selected: true
            }));

            renderFormatColumns();
            document.getElementById('format-columns-section').style.display = 'block';
        });

        // åˆ—æ•´å½¢ãƒ¢ãƒ¼ãƒ‰: ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        setupFileDrop('format-drop-zone', 'format-file', 'format-file-name', async (file, text) => {
            formatCsvData = parseCSV(text);
            if (formatCsvData.length === 0) return;

            formatColumns = formatCsvData[0].map((name, index) => ({
                original: name,
                name: name,
                index: index,
                selected: true
            }));

            renderFormatColumns();
            document.getElementById('format-columns-section').style.display = 'block';
        });

        function renderFormatColumns() {
            const container = document.getElementById('format-columns');
            container.innerHTML = '';

            formatColumns.forEach((col, idx) => {
                const div = document.createElement('div');
                div.className = 'column-item';
                div.draggable = true;
                div.dataset.index = idx;

                div.innerHTML = `
                    <span class="drag-handle">â˜°</span>
                    <input type="checkbox" class="column-checkbox" ${col.selected ? 'checked' : ''}>
                    <span class="column-name">${col.original}</span>
                    <input type="text" class="column-rename" value="${col.name}" placeholder="ãƒªãƒãƒ¼ãƒ ">
                `;

                div.querySelector('.column-checkbox').addEventListener('change', (e) => {
                    formatColumns[idx].selected = e.target.checked;
                });

                div.querySelector('.column-rename').addEventListener('input', (e) => {
                    formatColumns[idx].name = e.target.value || col.original;
                });

                div.addEventListener('dragstart', handleFormatDragStart);
                div.addEventListener('dragover', handleFormatDragOver);
                div.addEventListener('drop', handleFormatDrop);
                div.addEventListener('dragend', handleFormatDragEnd);

                container.appendChild(div);
            });
        }

        let formatDraggedElement = null;

        function handleFormatDragStart(e) {
            formatDraggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleFormatDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';

            const items = Array.from(document.querySelectorAll('#format-columns .column-item'));
            items.forEach(item => item.classList.remove('drag-over'));

            if (this !== formatDraggedElement) {
                this.classList.add('drag-over');
            }

            return false;
        }

        function handleFormatDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (formatDraggedElement !== this) {
                const fromIndex = parseInt(formatDraggedElement.dataset.index);
                const toIndex = parseInt(this.dataset.index);

                const item = formatColumns.splice(fromIndex, 1)[0];
                formatColumns.splice(toIndex, 0, item);

                renderFormatColumns();
            }

            return false;
        }

        function handleFormatDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('#format-columns .column-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        document.getElementById('format-save-setting').addEventListener('click', () => {
            const name = document.getElementById('format-setting-name').value.trim();
            if (!name) {
                alert('è¨­å®šåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const setting = {
                name,
                columns: formatColumns
            };

            const settings = JSON.parse(localStorage.getItem('formatSettings') || '[]');
            const existingIndex = settings.findIndex(s => s.name === name);

            if (existingIndex >= 0) {
                if (!confirm('åŒåã®è¨­å®šãŒå­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ')) return;
                settings[existingIndex] = setting;
            } else {
                settings.push(setting);
            }

            localStorage.setItem('formatSettings', JSON.stringify(settings));
            alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            loadFormatSettings();
        });

        function loadFormatSettings() {
            const settings = JSON.parse(localStorage.getItem('formatSettings') || '[]');
            const container = document.getElementById('format-saved-settings');

            if (settings.length === 0) {
                document.getElementById('format-saved-settings-section').style.display = 'none';
                return;
            }

            document.getElementById('format-saved-settings-section').style.display = 'block';
            container.innerHTML = '';

            settings.forEach((setting, idx) => {
                const div = document.createElement('div');
                div.className = 'settings-item';

                div.innerHTML = `
                    <span class="settings-name">${setting.name}</span>
                    <div class="button-group">
                        <button class="btn btn-primary btn-sm settings-load">èª­è¾¼</button>
                        <button class="btn btn-danger btn-sm settings-delete">å‰Šé™¤</button>
                    </div>
                `;

                div.querySelector('.settings-load').addEventListener('click', () => {
                    if (formatCsvData) {
                        formatColumns = setting.columns;
                        renderFormatColumns();
                        alert('è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                    } else {
                        alert('è¨­å®šã‚’èª­ã¿è¾¼ã‚€ã«ã¯ã€ã¾ãšCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„');
                    }
                });

                div.querySelector('.settings-delete').addEventListener('click', () => {
                    if (confirm(`è¨­å®šã€Œ${setting.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        settings.splice(idx, 1);
                        localStorage.setItem('formatSettings', JSON.stringify(settings));
                        loadFormatSettings();
                    }
                });

                container.appendChild(div);
            });
        }

        document.getElementById('format-export-setting').addEventListener('click', () => {
            const name = document.getElementById('format-setting-name').value.trim();
            if (!name) {
                alert('è¨­å®šåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const setting = {
                name,
                columns: formatColumns
            };

            const json = JSON.stringify(setting, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${name}.json`;
            link.click();
        });

        document.getElementById('format-import-setting').addEventListener('click', () => {
            document.getElementById('format-import-file').click();
        });

        document.getElementById('format-import-file').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const text = await readFile(file);
                const setting = JSON.parse(text);

                const settings = JSON.parse(localStorage.getItem('formatSettings') || '[]');
                const existingIndex = settings.findIndex(s => s.name === setting.name);

                if (existingIndex >= 0) {
                    if (!confirm('åŒåã®è¨­å®šãŒå­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ')) return;
                    settings[existingIndex] = setting;
                } else {
                    settings.push(setting);
                }

                localStorage.setItem('formatSettings', JSON.stringify(settings));
                alert('è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
                loadFormatSettings();
            } catch (err) {
                alert('è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }

            e.target.value = '';
        });

        document.getElementById('format-run').addEventListener('click', () => {
            if (!formatCsvData) {
                alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const result = [
                formatColumns.filter(col => col.selected).map(col => col.name)
            ];

            for (let i = 1; i < formatCsvData.length; i++) {
                const row = formatColumns
                    .filter(col => col.selected)
                    .map(col => formatCsvData[i][col.index] || '');
                result.push(row);
            }

            const originalFileName = document.getElementById('format-file-name').textContent;
            const baseName = originalFileName.replace(/\.csv$/i, '');
            const timestamp = formatDateTime(new Date());
            downloadCSV(result, `${baseName}_æ•´å½¢æ¸ˆã¿_${timestamp}.csv`);
        });

        // å®Ÿè¡Œãƒ­ã‚°
        function saveExecutionLog(settingName, fileNameA, fileNameB, outputRows, hasWarnings, removedCount) {
            const logs = JSON.parse(localStorage.getItem('executionLogs') || '[]');

            const log = {
                id: Date.now(),
                date: new Date().toISOString(),
                settingName,
                fileNameA,
                fileNameB,
                outputRows,
                hasWarnings,
                removedCount
            };

            logs.unshift(log);

            if (logs.length > 100) {
                logs.splice(100);
            }

            localStorage.setItem('executionLogs', JSON.stringify(logs));
        }

        function loadExecutionLog() {
            const logs = JSON.parse(localStorage.getItem('executionLogs') || '[]');
            const container = document.getElementById('log-list');

            if (logs.length === 0) {
                container.innerHTML = '<p style="color: #6c757d;">å®Ÿè¡Œå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            container.innerHTML = '';

            logs.forEach((log, idx) => {
                const div = document.createElement('div');
                div.className = 'log-item';

                const date = new Date(log.date);
                const dateStr = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;

                div.innerHTML = `
                    <div class="log-header">
                        <div>
                            <span class="log-title">${log.settingName}</span>
                            ${log.hasWarnings ? '<span class="warning-badge">è­¦å‘Šã‚ã‚Š</span>' : ''}
                        </div>
                        <span class="log-date">${dateStr}</span>
                    </div>
                    <div class="log-details">
                        <div class="log-detail-item"><strong>ãƒ•ã‚¡ã‚¤ãƒ«A:</strong> ${log.fileNameA}</div>
                        <div class="log-detail-item"><strong>ãƒ•ã‚¡ã‚¤ãƒ«B:</strong> ${log.fileNameB}</div>
                        <div class="log-detail-item"><strong>å‡ºåŠ›è¡Œæ•°:</strong> ${log.outputRows}è¡Œ</div>
                        ${log.removedCount > 0 ? `<div class="log-detail-item"><strong>é‡è¤‡é™¤å»:</strong> ${log.removedCount}è¡Œ</div>` : ''}
                    </div>
                `;

                div.querySelector('.log-header').addEventListener('click', () => {
                    const details = div.querySelector('.log-details');
                    details.classList.toggle('show');
                });

                container.appendChild(div);
            });
        }

        document.getElementById('log-clear-all').addEventListener('click', () => {
            if (confirm('ã™ã¹ã¦ã®å®Ÿè¡Œãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('executionLogs');
                loadExecutionLog();
            }
        });

        // åˆæœŸåŒ–
        loadSavedSettings();
    </script>
</body>
</html>