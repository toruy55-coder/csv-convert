# CSV Merger Tool

## プロジェクト概要
2つのCSVファイル（A・B）を結合してCSV（C）を出力するブラウザ完結型Webアプリ。
HTML / CSS / JavaScript を1ファイル（index.html）に完結させる。外部ライブラリは使用しない。
定型業務の自動実行には Python スクリプト（run.py）を使う。

## ファイル構成
```
csv-tool/
├── CLAUDE.md                  # このファイル
├── index.html                 # ブラウザ用アプリ本体（定義・実行・列整形モード）
├── run.py                     # ワンクリック実行スクリプト
├── run.bat                    # Windowsダブルクリック実行用バッチファイル
├── config/
│   └── settings.json          # ブラウザからエクスポートした設定ファイル
├── input/                     # 入力CSVを置くフォルダ
├── output/                    # 変換結果が自動出力されるフォルダ
│   └── run_log.csv            # 実行ログの累積ファイル
├── test_a.csv                 # テスト用入力データA（社員マスタ想定・10行）
├── test_b.csv                 # テスト用入力データB（売上データ想定・8行）
├── test_single.csv            # 列整形モード用テストデータ（15行）
└── test_report.md             # テスト結果レポート（自動更新）
```

## 画面構成（ブラウザ・3タブ）

### 共通：定義モードの「＋ 新規作成」ボタン
- 画面上部に常時表示
- クリックすると「現在の設定をクリアして新しい定義を作成しますか？」の確認ダイアログを表示
- OKで全項目を初期状態にリセットする

### 共通：ファイルアップロードエリア
- クリックでOSのファイル選択ダイアログを開く
- CSVファイルをエリアにドラッグ＆ドロップしても投入できる
- ドラッグ中はエリアをハイライト表示する

---

### タブ1：定義モード
結合ルール・出力カラム・変換ルールを定義してlocalStorageに保存する。

- **3-1 ファイル構造の確認**
  - A・BのCSVをアップロードしてヘッダーと先頭4行をプレビュー表示
  - このファイルは「定義用サンプル」であり実行モードのファイルとは独立

- **3-2 結合ルールの設定**
  - 結合キー（A側・B側）を指定
  - 結合方法の表示名（内部値）：
    - 「両方に一致する行だけ出力」（inner）
    - 「Aを基準にBを補完」（left）
    - 「Bを基準にAを補完」（right）
    - 「すべての行を出力（全結合）」（outer）

- **3-3 出力カラムの定義**
  - カラムをリスト表示、クリックで選択・除外
  - 左端ハンドル（⠿）でドラッグ＆ドロップ並び替え（HTML5 Drag and Drop API）
  - テキスト入力でリネーム
  - A由来は緑系・B由来は紫系で色分け
  - 同名カラムはBに「_b」サフィックス自動付与

- **3-4 フォーマット変換ルール**
  - 対象カラム・変換前の値・変換後の値を複数登録可能

- **3-5 ワンクリック実行用ファイルパス定義**
  - 入力A・Bのファイル名と出力ベース名を事前定義

- **3-6 データ検証設定**
  - 空白キー・重複キー・カラム数不一致のチェックをオン・オフ設定
  - 警告時は「このまま実行」「キャンセル」をユーザーが選択

- **3-7 重複行除去設定**
  - 出力後の重複行を自動集約するオン・オフのトグル
  - 除去した行数を結果サマリーに表示

- **3-8 設定の保存・管理**
  - 名前をつけてlocalStorageに保存・読込・削除
  - JSONでエクスポート・インポート（複数PC対応）

---

### タブ2：実行モード
保存済み設定を選んでCSVを投入し実行する。

- 設定をドロップダウンで選択してサマリー表示
- A・BのCSVをドラッグ＆ドロップまたはクリックでアップロード
- 「▶ 変換を実行」ボタンで処理
- 結果サマリー（行数・カラム数・除去重複行数）と先頭20行プレビューを表示
- BOM付きUTF-8のCSVをダウンロード

---

### タブ3：列整形モード
1ファイルの列順変更・除外・リネームを行う。

- CSVを1ファイルアップロードエリアに投入（クリックまたはドラッグ＆ドロップ）
- ドラッグ＆ドロップで列の順序変更
- クリックで列の除外・選択切り替え（「すべて選択」「すべて除外」ボタンあり）
- テキスト入力でリネーム
- 整形設定を名前をつけてlocalStorageに保存・エクスポート・インポート
- 出力ファイル名：`{元ファイル名}_整形済み_{YYYYMMDDHHMMSS}.csv`

---

### 実行ログ（共通）
変換実行のたびに日時・設定名・ファイル名・出力行数・警告の有無を自動保存。
最大100件。CSV出力・全削除が可能。

---

## ワンクリック実行（Python スクリプト方式）

ブラウザのセキュリティ制限のため、定型業務の自動実行は run.py で行う。

### 実行手順
1. ブラウザの定義モードで設定を作りJSONエクスポート
2. エクスポートしたJSONを `config/settings.json` として保存
3. 入力CSVファイルを `input/` フォルダに置く
4. `python run.py` を実行（Windowsは `run.bat` をダブルクリック）
5. `output/` に結果ファイルが自動生成される

### run.py の仕様
- `config/settings.json` を読み込み inputFileA・inputFileB で `input/` 内のファイルを特定
- 設定に従い結合・変換・重複除去を実行
- 出力ファイル名：`{outputBaseName}_{YYYYMMDDHHMMSS}.csv`
- 実行結果（行数・カラム数・除去重複行数・警告）をターミナルに表示
- `output/run_log.csv` に実行ログを追記
- Python 標準ライブラリのみ使用（csv・json・os・datetime）、追加インストール不要

### run.bat の仕様（Windows用）
- run.py を呼び出す1行バッチ、完了後 pause で画面を残す
- Python 未インストール時はエラーメッセージを表示して終了

> Python 3.8以上が必要。未インストールの場合は https://www.python.org/ から入手。

---

## 技術仕様
| 項目 | 内容 |
|------|------|
| ブラウザアプリ | HTML/CSS/JS 1ファイル完結（index.html） |
| 外部ライブラリ | 不使用 |
| 設定保存先 | localStorage（ブラウザ・端末ごとに独立） |
| 設定移行 | JSONエクスポート・インポートで複数PC対応 |
| 出力文字コード | BOM付きUTF-8（Excel対応） |
| 動作ブラウザ | Chrome / Edge / Firefox / Safari |
| スクリプト | Python 3.8以上、標準ライブラリのみ |

## 設定JSONの構造

### マージ設定
```json
{
  "name": "設定名",
  "keyA": "結合キー（A側カラム名）",
  "keyB": "結合キー（B側カラム名）",
  "joinType": "inner | left | right | outer",
  "selectedCols": ["カラム名の配列（順序が列順に反映）"],
  "colRenames": { "元カラム名": "出力カラム名" },
  "rules": [{ "col": "対象カラム", "from": "変換前", "to": "変換後" }],
  "validation": {
    "checkEmptyKey": true,
    "checkDuplicateKey": true,
    "checkColumnCount": true
  },
  "deduplication": false,
  "inputFileA": "sales_a.csv",
  "inputFileB": "master_b.csv",
  "outputBaseName": "sales_merged",
  "createdAt": "2026-02-18T00:00:00Z"
}
```

### 列整形設定
```json
{
  "name": "設定名",
  "selectedCols": ["カラム名の配列（順序が列順に反映）"],
  "colRenames": { "元カラム名": "出力カラム名" },
  "deduplication": false,
  "createdAt": "2026-02-18T00:00:00Z"
}
```

## 作業ルール
- 私が「OK」と言うまで index.html・run.py を上書きしない
- 変更を加える前に必ずdiffを見せること
- 機能を追加・修正したら test_report.md を更新すること
- 不具合が見つかった場合は原因を説明してから修正案を提示すること

## テストについて
- テストデータ（test_a.csv / test_b.csv / test_single.csv）は自動生成済み
- テストケース TC-01〜TC-09 を実行し test_report.md に結果を記録する
- 不合格があれば修正→再テストを全件合格になるまで繰り返す
