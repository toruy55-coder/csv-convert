# CSV結合・変換ツール - 仕様書

## プロジェクト概要

CSV結合・変換ツールは、2つのCSVファイルを結合し、データ変換・検証を行うWebアプリケーションおよびPythonスクリプトです。ブラウザベースのGUIで設定を作成し、Pythonスクリプトで自動実行できる構成になっています。

**バージョン**: 1.0
**作成日**: 2026-02-22
**対応言語**: 日本語

---

## 技術仕様

### Webアプリケーション版 (index.html)

- **ファイル構成**: 単一HTMLファイル（HTML/CSS/JavaScript統合）
- **外部依存**: なし（外部ライブラリ不使用）
- **文字エンコーディング**: UTF-8（BOM付き出力）
- **対応ブラウザ**: モダンブラウザ（Chrome, Firefox, Edge, Safari）
- **データ永続化**: LocalStorage API
- **ファイルアップロード**: File API + HTML5 Drag and Drop API

### Pythonスクリプト版 (run.py)

- **Python**: 3.6以上
- **依存ライブラリ**: なし（標準ライブラリのみ）
- **使用モジュール**: csv, json, os, sys, datetime, collections
- **文字エンコーディング**: UTF-8（BOM付き入出力）
- **実行環境**: Windows/Mac/Linux

---

## 機能要件

### 1. タブ構成（Webアプリケーション）

#### 1.1 定義モード
**目的**: CSV結合の設定を作成・管理する

**機能**:
- CSV Aファイル選択（ファイル選択 + ドラッグ&ドロップ）
- CSV Bファイル選択（ファイル選択 + ドラッグ&ドロップ）
- 結合キー選択（カラムインデックス指定）
- 結合方式選択（Inner/Left/Right/Outer Join）
- 出力カラム設定
  - カラム選択（チェックボックス）
  - カラム並び替え（ドラッグ&ドロップ）
  - カラムリネーム（名前変更）
- 変換ルール設定
  - カラム指定
  - 変換前の値
  - 変換後の値
  - 複数ルール対応
- データ検証設定
  - 空白キーチェック
  - 重複キーチェック
  - カラム数不一致チェック
  - 重複行除去
- 設定の保存（LocalStorage）
- 設定のエクスポート（JSONファイル）
- 設定のインポート（JSONファイル読込）
- 新規作成ボタン（すべての設定をクリア）

**UI要素**:
- 設定名入力欄
- ファイル選択エリア（ドロップゾーン付き）
- 結合キー選択ドロップダウン
- 結合方式選択ラジオボタン
- カラムリスト（ドラッグ可能）
- 変換ルール追加/削除ボタン
- データ検証チェックボックス
- 保存ボタン
- エクスポートボタン
- インポートボタン
- 🆕新規作成ボタン

#### 1.2 実行モード
**目的**: 保存された設定を使用してCSV結合を実行する

**機能**:
- 設定選択（LocalStorageから読込）
- CSV Aファイル選択（ファイル選択 + ドラッグ&ドロップ）
- CSV Bファイル選択（ファイル選択 + ドラッグ&ドロップ）
- 即時実行
- データ検証実行
- 結合処理実行
- 変換ルール適用
- 重複行除去
- CSV出力（BOM付きUTF-8）
- 実行ログ記録（LocalStorage）
- プレビュー表示（最初の10行）

**UI要素**:
- 設定選択ドロップダウン
- ファイル選択エリア（ドロップゾーン付き）
- 実行ボタン
- プレビューテーブル
- エラー・警告表示エリア
- ダウンロードボタン

#### 1.3 ワンクリック実行モード
**目的**: 前回の実行を保存し、ワンクリックで再実行する

**機能**:
- 前回実行データの保存
  - 設定内容
  - ファイルA/Bのデータ
  - ファイル名
- 前回実行情報の表示
  - 設定名
  - ファイル名A
  - ファイル名B
  - 実行日時
- ワンクリック再実行
- 実行モードで実行した際に自動的に保存

**UI要素**:
- 前回実行情報表示エリア
- ワンクリック実行ボタン
- 実行モードへの誘導メッセージ（データがない場合）

**動作仕様**:
- 実行モードで実行すると、実行データをグローバル変数 `lastExecutionData` に保存
- ワンクリック実行モードを開いたとき、`lastExecutionData` の有無をチェック
- データがあれば前回実行情報を表示、なければ実行モードでの実行を促すメッセージを表示
- ワンクリック実行ボタンで保存されたデータを使って即座に実行

#### 1.4 カラム整形モード
**目的**: 単一CSVファイルのカラム整形を行う

**機能**:
- CSVファイル選択（ファイル選択 + ドラッグ&ドロップ）
- カラム選択（チェックボックス）
- カラム並び替え（ドラッグ&ドロップ）
- カラムリネーム
- 変換ルール適用
- 重複行除去
- CSV出力（BOM付きUTF-8）

**UI要素**:
- ファイル選択エリア（ドロップゾーン付き）
- カラムリスト（ドラッグ可能）
- 変換ルール追加/削除ボタン
- 重複行除去チェックボックス
- 実行ボタン
- プレビューテーブル
- ダウンロードボタン

#### 1.5 実行ログモード
**目的**: 過去の実行履歴を確認する

**機能**:
- 実行履歴の表示（LocalStorageから読込）
- 実行日時、設定名、ファイル名、出力行数、警告有無の表示
- ログのクリア機能

**UI要素**:
- 実行履歴テーブル
- ログクリアボタン

---

### 2. CSV結合処理

#### 2.1 結合方式

##### Inner Join
- 両方のCSVに存在するキーのみ結合
- A側の各行に対してB側のマッチする行を全て結合
- マッチしない行は出力されない

##### Left Join
- CSV Aのすべての行を出力
- A側の各行に対してB側のマッチする行を全て結合
- B側にマッチする行がない場合、B側のカラムは空白

##### Right Join
- CSV Bのすべての行を出力
- B側の各行に対してA側のマッチする行を全て結合
- A側にマッチする行がない場合、A側のカラムは空白

##### Outer Join
- 両方のCSVのすべての行を出力
- まずLeft Joinと同様にA側の行を処理
- その後、B側の未マッチ行を追加（A側のカラムは空白）

#### 2.2 結合アルゴリズム

**Inner/Left/Outer Join**:
1. B側をHashMap（キー→行リスト）に変換
2. A側の各行について：
   - キー値でB側のHashMapを検索
   - マッチする行がある場合、各B側行と結合して出力
   - マッチしない場合、Join方式に応じて処理
     - Inner: 出力しない
     - Left/Outer: B側カラムを空白にして出力
3. Outer Joinの場合、B側の未マッチ行を追加出力

**Right Join**:
1. A側をHashMap（キー→行リスト）に変換
2. B側の各行について：
   - キー値でA側のHashMapを検索
   - マッチする行がある場合、各A側行と結合して出力
   - マッチしない場合、A側カラムを空白にして出力

**重要な実装詳細**:
- 1対多の関係に対応（1つのキーに複数行マッチ）
- 空白キーの扱い（空文字列もキーとして有効）
- カラムインデックス範囲外チェック

---

### 3. データ検証

#### 3.1 空白キーチェック
- 結合キーカラムの値が空白（空文字列またはホワイトスペースのみ）の行を検出
- 検出数を警告として表示
- 処理は継続（エラーではない）

#### 3.2 重複キーチェック
- 同じキー値を持つ行が複数存在する場合に検出
- CSV AとCSV Bそれぞれで重複をチェック
- 検出数を警告として表示
- 処理は継続（1対多の結合は仕様上許可）

#### 3.3 カラム数不一致チェック
- ヘッダー行のカラム数とデータ行のカラム数が異なる行を検出
- 検出数を警告として表示
- 処理は継続（不足カラムは空白として扱う）

---

### 4. データ変換

#### 4.1 変換ルール適用
- カラム名を指定
- 変換前の値と変換後の値を定義
- 複数ルール対応（上から順に適用）
- 完全一致のみ対応（部分一致・正規表現は非対応）
- 空白から非空白への変換も可能

**適用順序**:
1. CSV結合
2. 変換ルール適用
3. 重複行除去

#### 4.2 重複行除去
- 全カラムの値が完全一致する行を重複とみなす
- 最初に出現した行のみを残す
- 除去された行数をログに記録

---

### 5. ファイル入出力

#### 5.1 入力CSV要件
- エンコーディング: UTF-8（BOMあり/なし両対応）
- 形式: カンマ区切り
- ヘッダー行: 必須（1行目）
- データ行: 2行目以降
- 改行コード: LF、CRLF両対応

#### 5.2 出力CSV仕様
- エンコーディング: UTF-8（BOM付き）
  - Excelで開いた際の文字化けを防ぐため
- 形式: カンマ区切り
- ヘッダー行: 1行目
- データ行: 2行目以降
- 改行コード: LF（\n）
- ファイル名形式: `{設定名}_{タイムスタンプ}.csv`
  - タイムスタンプ: YYYYMMDDHHmmss形式

---

### 6. 設定ファイル仕様（JSON）

#### 6.1 設定ファイル構造

```json
{
  "name": "設定名",
  "fileNameA": "ファイルA名.csv",
  "fileNameB": "ファイルB名.csv",
  "keyA": "結合キーカラムインデックス（文字列）",
  "keyB": "結合キーカラムインデックス（文字列）",
  "joinType": "inner|left|right|outer",
  "columns": [
    {
      "source": "A|B",
      "original": "元のカラム名",
      "name": "出力カラム名",
      "index": カラムインデックス（数値）,
      "selected": true|false
    }
  ],
  "rules": [
    {
      "column": "対象カラム名",
      "from": "変換前の値",
      "to": "変換後の値"
    }
  ],
  "validation": {
    "checkBlank": true|false,
    "checkDuplicate": true|false,
    "checkColumnCount": true|false,
    "removeDuplicates": true|false
  }
}
```

#### 6.2 フィールド説明

| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| name | String | Yes | 設定の名前 |
| fileNameA | String | Yes | CSV Aのファイル名 |
| fileNameB | String | Yes | CSV Bのファイル名 |
| keyA | String | Yes | CSV Aの結合キーカラムインデックス（0始まり） |
| keyB | String | Yes | CSV Bの結合キーカラムインデックス（0始まり） |
| joinType | String | Yes | 結合方式（inner/left/right/outer） |
| columns | Array | Yes | 出力カラム設定のリスト |
| rules | Array | No | 変換ルールのリスト |
| validation | Object | No | データ検証設定 |

**columns配列の要素**:
- source: "A"または"B"（どちらのCSVから取得するか）
- original: 元のカラム名
- name: 出力時のカラム名（リネーム可能）
- index: 元のCSVでのカラムインデックス（0始まり）
- selected: 出力に含めるかどうか

**rules配列の要素**:
- column: 対象カラム名（出力後のカラム名）
- from: 変換前の値
- to: 変換後の値

**validationオブジェクト**:
- checkBlank: 空白キーチェックを行うか
- checkDuplicate: 重複キーチェックを行うか
- checkColumnCount: カラム数不一致チェックを行うか
- removeDuplicates: 重複行除去を行うか

---

### 7. Pythonスクリプト版

#### 7.1 機能
- コマンドライン引数で設定ファイルを指定
- 引数なしの場合、カレントディレクトリの.jsonファイルを自動検出
- 入力ファイルの柔軟な配置
  - カレントディレクトリを優先検索
  - 見つからない場合 `input/` フォルダを検索
- フォルダの自動作成
  - `input/` フォルダ
  - `output/` フォルダ
- WebUI版と同一のCSV結合ロジック
- WebUI版と同一のデータ検証
- WebUI版と同一のデータ変換
- 実行ログのCSV出力（`output/run_log.csv`）
- エラーハンドリング（詳細なエラーメッセージ）

#### 7.2 使用方法

**基本実行**（設定ファイル自動検出）:
```bash
python run.py
```

**設定ファイル指定**:
```bash
python run.py settings.json
python run.py マスタ結合.json
```

**Windows（バッチファイル）**:
```bash
run.bat
run.bat settings.json
```

#### 7.3 フォルダ構成

```
csv-convert/
├── index.html                # Webアプリケーション
├── run.py                    # Pythonスクリプト
├── run.bat                   # Windows用バッチファイル
├── settings.json             # 設定ファイル（ルートディレクトリ）
├── test_a.csv                # 入力ファイルA（カレントでもOK）
├── test_b.csv                # 入力ファイルB（カレントでもOK）
├── input/                    # 入力フォルダ（自動作成）
│   ├── test_a.csv           # または input/ に配置
│   └── test_b.csv
└── output/                   # 出力フォルダ（自動作成）
    ├── テスト設定01_20260222123456.csv
    └── run_log.csv          # 実行ログ
```

#### 7.4 実行ログ形式

`output/run_log.csv`:

| カラム | 説明 |
|--------|------|
| 実行日時 | YYYY-MM-DD HH:MM:SS形式 |
| 設定名 | 実行した設定の名前 |
| ファイルA | 入力ファイルAの名前 |
| ファイルB | 入力ファイルBの名前 |
| 出力行数 | 出力されたデータ行数（ヘッダー除く） |
| 警告有無 | "あり"または"なし" |
| 重複除去 | "{N}行"または"なし" |
| 出力ファイル | 出力されたCSVファイル名 |

---

### 8. ドラッグ&ドロップ機能

#### 8.1 対応箇所
- 定義モード: CSV A、CSV Bファイル選択
- 実行モード: CSV A、CSV Bファイル選択
- ワンクリック実行モード: 使用しない（前回実行データを使用）
- カラム整形モード: CSVファイル選択

#### 8.2 UI/UX
- ドロップゾーンに点線の枠
- ドラッグオーバー時に背景色を変更（視覚的フィードバック）
- ドロップ成功時にファイル名を表示
- CSVファイル以外は受け付けない（拡張子チェック）

#### 8.3 実装詳細
- HTML5 Drag and Drop APIを使用
- `dragover`イベントで`preventDefault()`を呼び出し
- `dragleave`イベントでスタイルをリセット
- `drop`イベントでファイルを取得・読込
- File APIでファイル内容をテキストとして読込

---

### 9. 状態管理

#### 9.1 LocalStorage（Webアプリケーション）

**保存内容**:
- `csvSettings`: 設定リスト（配列）
- `executionLog`: 実行ログリスト（配列）

**設定データ構造**:
```javascript
{
  id: 'unique_id',
  name: '設定名',
  fileNameA: 'test_a.csv',
  fileNameB: 'test_b.csv',
  keyA: '0',
  keyB: '0',
  joinType: 'left',
  columns: [...],
  rules: [...],
  validation: {...}
}
```

#### 9.2 グローバル変数（Webアプリケーション）

| 変数名 | 型 | 目的 |
|--------|-----|------|
| csvDataA | Array | CSV Aのデータ（定義モード） |
| csvDataB | Array | CSV Bのデータ（定義モード） |
| executeFileA | File | 実行モードで選択されたファイルA |
| executeFileB | File | 実行モードで選択されたファイルB |
| lastExecutionData | Object | 前回実行データ（ワンクリック実行用） |

**lastExecutionDataの構造**:
```javascript
{
  setting: {...},      // 使用した設定
  fileA: File,         // ファイルAのFileオブジェクト
  fileB: File,         // ファイルBのFileオブジェクト
  fileNameA: 'test_a.csv',
  fileNameB: 'test_b.csv',
  dataA: [...],        // CSV Aのデータ
  dataB: [...]         // CSV Bのデータ
}
```

---

### 10. エラーハンドリング

#### 10.1 Webアプリケーション

**検証エラー**:
- ファイル未選択
- 設定名未入力
- 結合キー未選択
- カラム未選択（最低1つ必要）

**実行時エラー**:
- CSV解析エラー
- データ型不一致
- メモリ不足（大容量ファイル）

**表示方法**:
- ポップアップアラート（警告・エラー）
- インラインエラーメッセージ（各入力フィールド）

#### 10.2 Pythonスクリプト

**エラーメッセージ**:
- 設定ファイルが見つからない
- 複数の設定ファイルが存在（引数で指定が必要）
- 入力ファイルが見つからない
- CSVファイル読込エラー
- 設定ファイル解析エラー

**エラー表示**:
- コンソールに詳細なエラーメッセージ
- 使用方法の表示（適切な場合）
- エラーコード1で終了

**警告メッセージ**:
- 空白キー検出
- 重複キー検出
- カラム数不一致検出

---

### 11. テストデータ仕様

#### 11.1 test_a.csv（社員マスタ）

**カラム**: 社員ID, 氏名, 部署, 入社年度

**データ特性**:
- 全9行（ヘッダー含む）
- 社員ID: 001〜009（003, 007はtest_bに存在しない）
- 重複なし

#### 11.2 test_b.csv（売上データ）

**カラム**: 社員ID, 売上金額, 達成率, 評価

**データ特性**:
- 全10行（ヘッダー含む）
- 社員ID: 001, 002, 004, 005, 006, 008, 009（003, 007は存在しない）
- 005が3行重複（1対多のテスト）
- 009はtest_aに存在しない（Outer/Right Joinテスト用）
- 評価カラム: 1, 2, 3（変換ルールテスト用）

**想定される変換ルール**:
- 評価 1 → 優
- 評価 2 → 良
- 評価 3 → 可

#### 11.3 test_single.csv（カラム整形用）

**カラム**: 8カラム

**データ特性**:
- 全15行（ヘッダー含む）
- カラム選択、並び替え、リネーム、重複除去のテスト用

---

### 12. 非機能要件

#### 12.1 パフォーマンス
- 小〜中規模CSV（〜10,000行）を想定
- Webアプリケーション: ブラウザのメモリ制限に依存
- Pythonスクリプト: 大容量ファイル対応（制限なし）

#### 12.2 ユーザビリティ
- 直感的なUI（日本語）
- ドラッグ&ドロップによる簡単操作
- 視覚的フィードバック（処理中表示、成功・エラー表示）
- プレビュー表示（最初の10行）

#### 12.3 保守性
- コメント付きコード
- 関数の単一責任原則
- 設定のJSON形式での外部化

#### 12.4 互換性
- Excel互換性（BOM付きUTF-8）
- Windows/Mac/Linux対応
- モダンブラウザ対応

---

### 13. 既知の制限事項

#### 13.1 Webアプリケーション
- 大容量ファイルはブラウザのメモリ制限で処理できない場合がある
- ファイル選択は毎回必要（ブラウザセキュリティ制約）
- LocalStorageの容量制限（約5-10MB、ブラウザ依存）

#### 13.2 Pythonスクリプト
- 設定ファイルはWebUIで作成する必要がある
- GUIなし（コマンドラインのみ）

#### 13.3 共通
- 部分一致・正規表現による変換は非対応
- 数値型の自動認識なし（すべて文字列として扱う）
- カラムのデータ型指定なし

---

### 14. 将来の拡張可能性

以下は現在未実装だが、将来実装を検討できる機能：

1. **フィルタリング機能**
   - 条件に一致する行のみ出力
   - 正規表現サポート

2. **集計機能**
   - グループ化
   - 合計、平均、最大値、最小値

3. **データ型サポート**
   - 数値型、日付型の自動認識
   - データ型に基づくソート

4. **複数ファイル結合**
   - 3つ以上のCSVの結合
   - 連鎖的な結合

5. **Pythonスクリプトの自動実行**
   - Watchモード（ファイル変更検知）
   - スケジューラー連携

6. **高度な変換**
   - 計算式サポート
   - 複数カラムの結合
   - 文字列操作関数

---

## バグ修正履歴

### Bug #1: Right Join実装エラー
**症状**: Right Joinでマッチした行がスキップされる

**原因**: Right JoinとOuter Joinのロジックが混在していた

**修正内容**:
- Right JoinとOuter Joinを完全に分離
- Right Join専用のロジックを実装（B側をループ、A側をHashMapで検索）

### Bug #2: 実行モードでファイル選択エラー
**症状**: ドラッグ&ドロップでファイルを選択しても「両方のCSVファイルを選択してください」エラー

**原因**: `setupFileDrop()`関数でファイルをローカル変数に保存していたが、実行ボタンのイベントハンドラーが`input.files[0]`を参照していた

**修正内容**:
- グローバル変数 `executeFileA`、`executeFileB` を追加
- ファイル選択（input.change）とドラッグ&ドロップの両方でグローバル変数を更新
- 実行ボタンでグローバル変数を参照するように変更

---

## まとめ

本仕様書は、CSV結合・変換ツールの完全な技術仕様とビジネス要件を記載しています。WebアプリケーションとPythonスクリプトの両方を提供し、ユーザーが設定作成はブラウザで、自動実行はPythonで行えるハイブリッド構成を採用しています。

**推奨される使用フロー**:
1. Webアプリケーション（index.html）で設定を作成
2. 設定をJSONエクスポート
3. Pythonスクリプト（run.py）で自動実行
4. 必要に応じてcronやタスクスケジューラーで定期実行

この構成により、使いやすいUIと自動化の両立を実現しています。
